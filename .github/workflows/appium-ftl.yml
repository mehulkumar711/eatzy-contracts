name: Appium FTL CI

on:
  workflow_run:
    workflows: ["Android Build"] # Triggered after the build job
    types:
      - completed

jobs:
  run-ftl-matrix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # Only run if build passed
    strategy:
      matrix:
        device:
          - model: redfin,version=30,locale=en,orientation=portrait # Pixel 5, Android 11
          - model: gts4lvwifi,version=28,locale=en,orientation=portrait # Samsung Tab, Android 9
          - model: FTL-iPhone-11,version=15.0 # iPhone 11, iOS 15
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: GCloud Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY_FTL }}'
          
      - name: Set up gcloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      # Patched: Download the *real* artifacts from the completed build job
      - name: 'Download Real App Artifacts'
        uses: actions/download-artifact@v4
        with:
          name: eatzy-vendor-app-apk # Must match the upload-artifact name
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}

      - name: 'Download Real Appium Tests'
        uses: actions/download-artifact@v4
        with:
          name: eatzy-appium-tests-zip # Must match the upload-artifact name
          path: ./artifacts
          run-id: ${{ github.event.workflow_run.id }}

      - name: Run Firebase Test Lab
        id: ftl
        run: |
          gcloud firebase test android run \
            --type appium \
            --app ./artifacts/app-to-test.apk \
            --test ./artifacts/appium-tests.zip \
            --device ${{ matrix.device }} \
            --timeout 10m \
            --results-bucket=gs://eatzy-ftl-results \
            --results-dir=ftl-results/${{ github.sha }}/${{ matrix.device }}
      
      - name: Check FTL Results
        if: failure()
        run: |
          echo "FTL test on ${{ matrix.device }} failed."
          exit 1